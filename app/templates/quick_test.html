{% extends "base.html" %}

{% block title %}Quick Test - MedGuardian{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white text-center">
                    <h3><i class="fas fa-vial me-2"></i>Quick Test Medication</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Create a test medication scheduled <strong>2 minutes from now</strong> to test the reminder
                        system.
                    </div>

                    <form id="testForm">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-pills me-2"></i>Medication Name</label>
                            <input type="text" class="form-control" id="testMedName" value="Test Aspirin" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-prescription-bottle me-2"></i>Dosage</label>
                            <input type="text" class="form-control" id="testDosage" value="100mg" required>
                        </div>

                        <div class="alert alert-warning">
                            <small><i class="fas fa-clock me-1"></i>Scheduled Time: <strong
                                    id="testTime"></strong></small>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus-circle me-2"></i>Create Test Medication
                            </button>
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                            </a>
                        </div>
                    </form>

                    <div id="result" class="mt-3" style="display: none;"></div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h5>How it works:</h5>
                    <ol>
                        <li>Click "Create Test Medication"</li>
                        <li>Medication is created immediately</li>
                        <li>Reminder scheduled for 2 minutes from now</li>
                        <li>Wait ~2 minutes</li>
                        <li>Browser notification appears!</li>
                        <li>Click "Verify & Take" to test camera</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Calculate and display time
    function updateTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() + 2);
        const timeStr = now.toTimeString().slice(0, 5);
        document.getElementById('testTime').textContent = timeStr;
    }
    updateTime();
    setInterval(updateTime, 1000);

    // Handle form submission
    document.getElementById('testForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const name = document.getElementById('testMedName').value;
        const dosage = document.getElementById('testDosage').value;
        const btn = e.target.querySelector('button[type="submit"]');
        const resultDiv = document.getElementById('result');

        // Disable button
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';

        try {
            const response = await fetch('/api/v1/medications/quick-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, dosage })
            });

            const data = await response.json();

            if (data.success) {
                resultDiv.className = 'alert alert-success mt-3';
                resultDiv.innerHTML = `
                <h5>âœ… Test Medication Created!</h5>
                <p><strong>Name:</strong> ${name} ${dosage}</p>
                <p><strong>Reminder Time:</strong> ${data.scheduled_time}</p>
                <p><strong>Wait ~2 minutes</strong> for the notification to appear!</p>
                <a href="{{ url_for('main.dashboard') }}" class="btn btn-success">Go to Dashboard</a>
            `;
                resultDiv.style.display = 'block';

                // Auto-redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.dashboard") }}';
                }, 3000);
            } else {
                throw new Error(data.error || 'Failed to create medication');
            }
        } catch (error) {
            resultDiv.className = 'alert alert-danger mt-3';
            resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
            resultDiv.style.display = 'block';

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plus-circle me-2"></i>Create Test Medication';
        }
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Analytics Dashboard - MedGuardian{% endblock %}

{% block head %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .analytics-page .page-header {
        background: var(--primary-color);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 1.5rem;
    }

    .analytics-page .stat-card {
        border-radius: 16px;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease;
    }

    .analytics-page .stat-card:hover {
        transform: translateY(-3px);
    }

    .analytics-page .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .analytics-page .chart-card {
        border-radius: 16px;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .analytics-page .chart-card .card-header {
        border-radius: 16px 16px 0 0;
    }

    .analytics-page .chart-container {
        height: 250px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid analytics-page py-4">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-chart-line me-2"></i>Analytics Dashboard
                </h2>
                <p class="mb-0 opacity-90">Track your medication adherence and progress</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light" onclick="refreshData()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button class="btn btn-warning" onclick="exportReport()">
                    <i class="fas fa-file-pdf me-1"></i>Export PDF
                </button>
            </div>
        </div>
    </div>


    <!-- Summary Cards -->
    <div class="row mb-4">
        <!-- IoT Device Card (High Impact) -->
        <div class="col-md-4 mb-3">
            <div class="card stat-card h-100 bg-info bg-opacity-10 border-info">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-info text-white me-3">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <div>
                        <div class="d-flex align-items-center">
                            <h5 class="mb-0 fw-bold">Smart Pill Box</h5>
                            <span class="badge bg-success ms-2 pulse-slow" id="iotStatus">Online</span>
                        </div>
                        <small class="text-muted d-block" id="iotDeviceInfo">Syncing with GUARDIAN-VBOX-001</small>
                        <div id="iotLastEvent" class="x-small text-info mt-1 fw-bold">No recent events</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-primary text-white mx-auto mb-2">
                        <i class="fas fa-pills"></i>
                    </div>
                    <h3 class="mb-0" id="totalMeds">-</h3>
                    <small class="text-muted">Total Medications</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 col-sm-4 mb-3">
            <div class="card stat-card h-100">
                <div class="card-body text-center">
                    <div class="stat-icon bg-success text-white mx-auto mb-2">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h3 class="mb-0" id="takenToday">-</h3>
                    <small class="text-muted">Taken Today</small>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card stat-card h-100 bg-dark text-white border-primary shadow-lg"
                style="border: 2px solid var(--primary-color) !important;">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-primary text-white me-3">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div>
                        <h4 class="mb-0" id="forecastedRisk">Calculating...</h4>
                        <small class="text-primary fw-bold">ML Predictive Risk Score</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse-slow {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        .pulse-slow {
            animation: pulse-slow 2s infinite;
        }
    </style>

    <!-- Charts Row 1 -->
    <div class="row mb-4">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Weekly Compliance</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-pie-chart me-2"></i>Time Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="distributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row">
        <!-- New Bio-Twin Chart (Takes up full width for impact) -->
        <div class="col-12 mb-4">
            <div class="card shadow-sm h-100 border-primary">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center"
                    style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%) !important;">
                    <h5 class="mb-0">
                        <i class="fas fa-dna me-2 text-info"></i>Bio-Digital Twin: Pharmacokinetic Simulation
                    </h5>
                    <span class="badge bg-info">Experimental Model</span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-9">
                            <div class="chart-container" style="height: 300px;">
                                <canvas id="bioTwinChart"></canvas>
                            </div>
                        </div>
                        <div class="col-md-3 border-start">
                            <h6 class="text-muted text-uppercase x-small">Current Status</h6>
                            <h3 id="currentConcentration" class="mb-1 text-primary">--%</h3>
                            <small id="bioStatusText" class="d-block mb-3 text-muted">Awaiting Simulation...</small>

                            <hr>

                            <h6 class="text-muted text-uppercase x-small">Bio-Safety Window</h6>
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-success me-2"
                                    style="width: 10px; height: 10px; padding: 0; border-radius: 50%;"></span>
                                <small>Optimal (>20%)</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-danger me-2"
                                    style="width: 10px; height: 10px; padding: 0; border-radius: 50%;"></span>
                                <small>Sub-Therapeutic (<20%)< /small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Monthly Trend</h5>
                </div>
                <!-- ... existing trend chart ... -->
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm h-100 border-primary">
                <div
                    class="card-header bg-white text-dark d-flex justify-content-between align-items-center border-bottom">
                    <h5 class="mb-0"><i class="fas fa-microchip me-2 text-primary"></i>Next-Dose Forecast (AIML)</h5>
                    <span class="badge bg-primary">Real-time</span>
                </div>
                <div class="card-body">
                    <div id="mlForecastContainer">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-2">Computing future risks...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let weeklyChart, distributionChart, trendChart, bioTwinChart;

    // Initialize charts
    document.addEventListener('DOMContentLoaded', function () {
        initCharts();
        loadData();
    });

    function initCharts() {
        const isDark = document.body.classList.contains('dark-mode');
        const textColor = isDark ? '#e2e8f0' : '#343a40';
        const gridColor = isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

        Chart.defaults.color = textColor;

        // --- NEW: Bio-Digital Twin Chart ---
        const ctxBio = document.getElementById('bioTwinChart').getContext('2d');
        const gradient = ctxBio.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(56, 189, 248, 0.5)'); // Light Blue
        gradient.addColorStop(1, 'rgba(56, 189, 248, 0.0)');

        bioTwinChart = new Chart(ctxBio, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Serum Concentration (mg/L)',
                    data: [],
                    borderColor: '#38bdf8',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0
                }, {
                    label: 'Toxicity Threshold',
                    data: [],
                    borderColor: '#ef4444',
                    borderDash: [5, 5],
                    borderWidth: 1,
                    fill: false,
                    pointRadius: 0
                }, {
                    label: 'Therapeutic Minimum',
                    data: [],
                    borderColor: '#10b981',
                    borderDash: [5, 5],
                    borderWidth: 1,
                    fill: false,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { labels: { color: textColor } },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function (context) {
                                return context.parsed.y + '% Concentration';
                            }
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 30, // Normalizing to 30mg/L scale
                        title: { display: true, text: 'Drug Plasma Concentration (mg/L)' },
                        grid: { color: gridColor }
                    },
                    x: { grid: { display: false } }
                }
            }
        });

        // Weekly compliance chart
        weeklyChart = new Chart(document.getElementById('weeklyChart'), {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Taken',
                    data: [],
                    backgroundColor: 'rgba(40, 167, 69, 0.8)',
                    borderRadius: 5
                }, {
                    label: 'Missed',
                    data: [],
                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: gridColor } },
                    x: { grid: { display: false } }
                }
            }
        });

        // Distribution pie chart
        distributionChart = new Chart(document.getElementById('distributionChart'), {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(23, 162, 184, 0.8)',
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(40, 167, 69, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });

        // Trend line chart (Simplified for brevity in replacement)
        trendChart = new Chart(document.getElementById('trendChart'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Compliance %', data: [], borderColor: 'rgba(23, 162, 184, 1)', backgroundColor: 'rgba(23, 162, 184, 0.2)', fill: true, tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100, grid: { color: gridColor } }, x: { grid: { display: false } } } }
        });
    }

    async function loadData() {
        await Promise.all([
            loadSummary(),
            loadCompliance(),
            loadDistribution(),
            loadTrends(),
            loadMLAnomalies(),
            loadBioTwin() // NEW
        ]);
        generateInsights();
    }

    async function loadBioTwin() {
        try {
            const response = await fetch('/analytics/api/bio-twin');
            const data = await response.json();

            // Update Chart
            if (data.forecast && data.forecast.points) {
                const points = data.forecast.points;
                const windows = data.forecast.windows;

                bioTwinChart.data.labels = points.map(p => p.time);
                bioTwinChart.data.datasets[0].data = points.map(p => p.concentration);

                // Overlay Window Lines
                bioTwinChart.data.datasets[1].data = points.map(() => 15); // Toxicity Threshold
                bioTwinChart.data.datasets[2].data = points.map(() => 5);  // Therapeutic Minimum

                bioTwinChart.update();
            }

            // Update Current Status Info
            if (data.current_status && data.current_status.length > 0) {
                const mainMed = data.current_status[0];
                document.getElementById('currentConcentration').textContent = mainMed.concentration_mg_l + ' mg/L';
                document.getElementById('bioStatusText').textContent = mainMed.status;

                const statusEl = document.getElementById('currentConcentration');
                if (mainMed.status.includes('Toxicity')) statusEl.className = "mb-1 text-danger fw-bold";
                else if (mainMed.status.includes('Sub')) statusEl.className = "mb-1 text-warning fw-bold";
                else statusEl.className = "mb-1 text-success fw-bold";
            }

        } catch (error) {
            console.error('Failed to load Bio-Twin simulation:', error);
        }
    }

    async function loadMLAnomalies() {
        try {
            const response = await fetch('/api/v1/analytics/anomalies');
            const result = await response.json();

            if (result.success) {
                const data = result.data;
                document.getElementById('forecastedRisk').textContent = data.forecasted_risk + '%';

                // Color risk score
                const riskEl = document.getElementById('forecastedRisk');
                if (data.forecasted_risk > 60) riskEl.className = 'mb-0 text-danger';
                else if (data.forecasted_risk > 30) riskEl.className = 'mb-0 text-warning';
                else riskEl.className = 'mb-0 text-success';

                // Display ML Forecast list
                const container = document.getElementById('mlForecastContainer');
                if (data.ml_forecast && data.ml_forecast.length > 0) {
                    let html = '<ul class="list-group list-group-flush">';
                    data.ml_forecast.forEach(item => {
                        const prob = Math.round(item.probability * 100);
                        const progressColor = prob > 80 ? 'success' : (prob > 50 ? 'warning' : 'danger');
                        html += `
                            <li class="list-group-item px-0 border-0 mb-3 bg-transparent">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold fs-6">${item.medication}</span>
                                    <span class="badge bg-light text-dark border">${item.time}</span>
                                </div>
                                <div class="progress" style="height: 10px; border-radius: 10px;">
                                    <div class="progress-bar bg-${progressColor}" role="progressbar" 
                                         style="width: ${prob}%" aria-valuenow="${prob}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="d-flex justify-content-between x-small mt-1">
                                    <span class="text-muted">Adherence Probability</span>
                                    <span class="fw-bold text-${progressColor}">${prob}%</span>
                                </div>
                            </li>
                        `;
                    });
                    html += '</ul>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p class="text-muted text-center py-4">Insufficient data for ML forecasting.</p>';
                }
            }
        } catch (error) {
            console.error('Failed to load ML anomalies:', error);
        }
    }

    async function loadSummary() {
        try {
            const response = await fetch('/analytics/api/summary');
            const data = await response.json();

            document.getElementById('totalMeds').textContent = data.total_medications;
            document.getElementById('takenToday').textContent = data.taken_today;
            document.getElementById('pendingToday').textContent = data.pending_today;
            document.getElementById('complianceRate').textContent = data.compliance_rate + '%';
            document.getElementById('currentStreak').textContent = data.current_streak;
            document.getElementById('totalDoses').textContent = data.total_doses_month;
        } catch (error) {
            console.error('Failed to load summary:', error);
        }
    }

    async function loadCompliance() {
        try {
            const response = await fetch('/analytics/api/compliance');
            const data = await response.json();

            weeklyChart.data.labels = data.labels;
            weeklyChart.data.datasets[0].data = data.taken;
            weeklyChart.data.datasets[1].data = data.missed;
            weeklyChart.update();
        } catch (error) {
            console.error('Failed to load compliance:', error);
        }
    }

    async function loadDistribution() {
        try {
            const response = await fetch('/analytics/api/distribution');
            const data = await response.json();

            distributionChart.data.labels = data.labels;
            distributionChart.data.datasets[0].data = data.data;
            distributionChart.update();
        } catch (error) {
            console.error('Failed to load distribution:', error);
        }
    }

    async function loadTrends() {
        try {
            const response = await fetch('/analytics/api/trends');
            const data = await response.json();

            trendChart.data.labels = data.labels;
            trendChart.data.datasets[0].data = data.compliance;
            trendChart.update();
        } catch (error) {
            console.error('Failed to load trends:', error);
        }
    }

    function generateInsights() {
        const compliance = parseInt(document.getElementById('complianceRate').textContent) || 0;
        const streak = parseInt(document.getElementById('currentStreak').textContent) || 0;
        const pending = parseInt(document.getElementById('pendingToday').textContent) || 0;

        let insights = [];

        if (compliance >= 90) {
            insights.push({ icon: 'fa-trophy', color: 'success', text: 'Excellent! Your compliance rate is above 90%!' });
        } else if (compliance >= 70) {
            insights.push({ icon: 'fa-thumbs-up', color: 'info', text: 'Good job! Keep up the momentum.' });
        } else {
            insights.push({ icon: 'fa-exclamation-triangle', color: 'warning', text: 'Your compliance needs improvement. Set more reminders.' });
        }

        if (streak >= 7) {
            insights.push({ icon: 'fa-fire', color: 'danger', text: `Amazing ${streak}-day streak! You're on fire!` });
        } else if (streak >= 3) {
            insights.push({ icon: 'fa-star', color: 'warning', text: `Nice ${streak}-day streak! Keep it going!` });
        }

        if (pending > 0) {
            insights.push({ icon: 'fa-clock', color: 'info', text: `You have ${pending} medication(s) pending today.` });
        } else {
            insights.push({ icon: 'fa-check-circle', color: 'success', text: 'All medications taken for today!' });
        }

        const html = insights.map(i => `
        <div class="alert alert-${i.color} d-flex align-items-center mb-2">
            <i class="fas ${i.icon} me-3 fa-lg"></i>
            <span>${i.text}</span>
        </div>
    `).join('');

        document.getElementById('insightsContainer').innerHTML = html || '<p class="text-muted">No insights available.</p>';
    }

    function refreshData() {
        loadData();
    }

    function exportReport() {
        window.location.href = '/export/pdf-report';
    }

    // ==============================================
    // HYPER-WOW: IoT & PANIC LISTENERS
    // ==============================================
    const activeSocket = window.socket || window.seniorSocket || (window.reminderSystem ? window.reminderSystem.socket : null);

    if (activeSocket) {
        // IoT Device Event
        activeSocket.on('iot_event', function (data) {
            console.log('ðŸ“¡ IoT Event received:', data);
            const eventEl = document.getElementById('iotLastEvent');
            if (data.event === 'LID_OPENED') {
                eventEl.textContent = `Lid opened: ${data.medication} (${data.timestamp})`;
                eventEl.classList.replace('text-info', 'text-success');
                eventEl.closest('.card').classList.add('bg-success', 'bg-opacity-25');
                setTimeout(() => eventEl.closest('.card').classList.remove('bg-success', 'bg-opacity-25'), 3000);
            }
        });

        // Remote Caregiver Panic
        socket.on('panic_alert', function (data) {
            Swal.fire({
                title: 'ðŸš¨ EMERGENCY ALERT!',
                text: `Caregiver ${data.caregiver_name} is checking on you!`,
                icon: 'warning',
                confirmButtonText: 'I am OK!',
                confirmButtonColor: '#d33',
                backdrop: `rgba(255,0,0,0.4)`,
                allowOutsideClick: false
            });
            // Play sound if possible
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.play();
        });
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Edit Medication - MedGuardian{% endblock %}

{% block head %}
{{ super() }}
<style>
    .edit-med-page .page-header {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 1.5rem;
    }

    .edit-med-page .form-control-lg {
        font-size: 1.1rem;
        padding: 0.75rem 1rem;
    }

    .edit-med-page .card {
        border-radius: 16px !important;
        border: none !important;
    }

    .edit-med-page .form-control,
    .edit-med-page .form-select {
        background-color: #f8f9fa;
        border: none;
        border-radius: 10px;
        padding: 0.75rem 1rem;
    }

    .edit-med-page .form-control:focus,
    .edit-med-page .form-select:focus {
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(240, 147, 251, 0.2);
    }

    .edit-med-page .btn-primary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: none;
        border-radius: 50px;
        padding: 0.75rem 2rem;
    }

    .edit-med-page .preset-frequency.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
        border-color: transparent !important;
    }

    .edit-med-page .is-invalid {
        border: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container edit-med-page py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="page-header text-center">
                <h2 class="fw-bold mb-2"><i class="fas fa-edit me-2"></i>Edit Medication</h2>
                <p class="mb-0 opacity-90">Update details for {{ medication.name }}</p>
            </div>

            <form id="editForm" method="POST"
                action="{{ url_for('medication.edit_medication', medication_id=medication.id) }}"
                class="needs-validation" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                <!-- Section 1: Basic Info -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4 text-primary fw-bold">
                            <i class="fas fa-pills me-2"></i>Basic Information
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="name" class="form-label">Medication Name <span
                                        class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" id="name" name="name" required
                                    value="{{ medication.name }}" placeholder="e.g. Metformin">
                                <div class="invalid-feedback">Please enter the medication name</div>
                            </div>
                            <div class="col-md-4">
                                <label for="dosage" class="form-label">Dosage <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" id="dosage" name="dosage"
                                    required value="{{ medication.dosage }}" placeholder="e.g. 500mg">
                                <div class="invalid-feedback">Please enter dosage</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Schedule -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4 text-primary fw-bold">
                            <i class="fas fa-clock me-2"></i>Schedule
                        </h5>

                        <!-- Frequency Selector -->
                        <div class="mb-4">
                            <label class="form-label mb-3">How often?</label>
                            <input type="hidden" id="frequency" name="frequency"
                                value="{{ medication.frequency or '' }}">

                            <div class="row g-2" id="frequency-options">
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="Once daily" data-times='["08:00"]'>
                                        <i class="fas fa-sun d-block mb-2 text-warning fa-2x"></i>
                                        Once Daily
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="Twice daily" data-times='["08:00", "20:00"]'>
                                        <i class="fas fa-sync-alt d-block mb-2 text-info fa-2x"></i>
                                        Twice Daily
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="Three times daily" data-times='["08:00", "12:00", "18:00"]'>
                                        <i class="fas fa-clock d-block mb-2 text-primary fa-2x"></i>
                                        3x Daily
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="As needed" data-times='[]'>
                                        <i class="fas fa-hand-paper d-block mb-2 text-success fa-2x"></i>
                                        As Needed
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency-custom">
                                        <i class="fas fa-cog d-block mb-2 text-dark fa-2x"></i>
                                        Custom
                                    </button>
                                </div>
                            </div>
                            <div class="invalid-feedback" id="frequency-error">Please select a frequency</div>
                        </div>

                        <!-- Selected Frequency Display -->
                        <div id="selected-frequency"
                            class="alert alert-primary bg-primary bg-opacity-10 border-0 d-none mb-4">
                            <i class="fas fa-check-circle me-2"></i>
                            Selected: <strong id="frequency-display"></strong>
                        </div>

                        <!-- Custom Times -->
                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-clock me-2"></i>Reminder Times</span>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addCustomTime()">
                                    <i class="fas fa-plus me-1"></i>Add Time
                                </button>
                            </label>
                            <div id="custom-times-container" class="vstack gap-2"
                                data-existing-times="{{ medication.custom_reminder_times or '' }}">
                                <!-- Times will be loaded via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Details (Collapsible) -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3" role="button" data-bs-toggle="collapse"
                        data-bs-target="#detailsCollapse">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0 text-primary fw-bold">
                                <i class="fas fa-sliders-h me-2"></i>Additional Details
                            </h5>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                    </div>
                    <div class="collapse show" id="detailsCollapse">
                        <div class="card-body p-4 pt-0">
                            <!-- Instructions -->
                            <div class="mb-4">
                                <label for="instructions" class="form-label">Special Instructions</label>
                                <textarea class="form-control" id="instructions" name="instructions" rows="2"
                                    placeholder="e.g. Take with food">{{ medication.instructions or '' }}</textarea>
                            </div>

                            <!-- Dates -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="start_date" class="form-label">Start Date <span
                                            class="text-danger">*</span></label>
                                    <input type="date" class="form-control" id="start_date" name="start_date" required
                                        value="{{ medication.start_date or '' }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="end_date" class="form-label">End Date (Optional)</label>
                                    <input type="date" class="form-control" id="end_date" name="end_date"
                                        value="{{ medication.end_date or '' }}">
                                </div>
                            </div>

                            <!-- Priority -->
                            <div class="mb-3">
                                <label class="form-label">Priority Level</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="priority" id="p_low" value="low" {% if
                                        medication.priority=='low' %}checked{% endif %}>
                                    <label class="btn btn-outline-secondary" for="p_low">Low</label>

                                    <input type="radio" class="btn-check" name="priority" id="p_med" value="medium" {%
                                        if medication.priority=='medium' or not medication.priority %}checked{% endif
                                        %}>
                                    <label class="btn btn-outline-primary" for="p_med">Medium</label>

                                    <input type="radio" class="btn-check" name="priority" id="p_high" value="high" {% if
                                        medication.priority=='high' %}checked{% endif %}>
                                    <label class="btn btn-outline-warning" for="p_high">High</label>

                                    <input type="radio" class="btn-check" name="priority" id="p_crit" value="critical"
                                        {% if medication.priority=='critical' %}checked{% endif %}>
                                    <label class="btn btn-outline-danger" for="p_crit">Critical</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Actions -->
                <div class="d-grid gap-3 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg py-3 fw-bold shadow-sm">
                        <i class="fas fa-save me-2"></i>Update Medication
                    </button>
                    <a href="{{ url_for('medication.list_medications') }}"
                        class="btn btn-link text-muted text-decoration-none">
                        <i class="fas fa-arrow-left me-2"></i>Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('editForm');
        const frequencyField = document.getElementById('frequency');

        // Load existing frequency selection
        const existingFrequency = frequencyField.value;
        if (existingFrequency) {
            const matchingBtn = document.querySelector(`.preset-frequency[data-frequency="${existingFrequency}"]`);
            if (matchingBtn) {
                matchingBtn.classList.add('active');
                document.getElementById('frequency-display').textContent = existingFrequency;
                document.getElementById('selected-frequency').classList.remove('d-none');
            } else if (existingFrequency === 'Custom') {
                document.querySelector('.preset-frequency-custom').classList.add('active');
                document.getElementById('frequency-display').textContent = 'Custom Schedule';
                document.getElementById('selected-frequency').classList.remove('d-none');
            }
        }

        // Load existing custom times
        const container = document.getElementById('custom-times-container');
        const existingTimesData = container.getAttribute('data-existing-times');
        let existingTimes = [];

        if (existingTimesData) {
            try {
                existingTimes = JSON.parse(existingTimesData);
            } catch (e) {
                console.error('Error parsing times:', e);
            }
        }

        if (existingTimes && existingTimes.length > 0) {
            existingTimes.forEach(time => addCustomTimeInput(time));
        }

        // Frequency button clicks
        document.querySelectorAll('.preset-frequency').forEach(btn => {
            btn.addEventListener('click', function () {
                // Remove active from all
                document.querySelectorAll('.preset-frequency, .preset-frequency-custom').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const freq = this.getAttribute('data-frequency');
                frequencyField.value = freq;

                document.getElementById('frequency-display').textContent = freq;
                document.getElementById('selected-frequency').classList.remove('d-none');
                document.getElementById('frequency-error').style.display = 'none';

                // Set times
                const times = JSON.parse(this.getAttribute('data-times') || '[]');
                container.innerHTML = '';
                times.forEach(t => addCustomTimeInput(t));
            });
        });

        // Custom frequency
        document.querySelector('.preset-frequency-custom').addEventListener('click', function () {
            document.querySelectorAll('.preset-frequency, .preset-frequency-custom').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            frequencyField.value = 'Custom';
            document.getElementById('frequency-display').textContent = 'Custom Schedule';
            document.getElementById('selected-frequency').classList.remove('d-none');
            document.getElementById('frequency-error').style.display = 'none';
        });

        // Form validation with auto-scroll
        form.addEventListener('submit', function (e) {
            console.log('Form submit triggered');
            let isValid = true;
            let firstInvalid = null;

            // Check required fields (name, dosage, start_date)
            const requiredFields = form.querySelectorAll('input[required]:not([type="hidden"])');
            requiredFields.forEach(field => {
                console.log('Checking field:', field.name, 'value:', field.value);
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                    if (!firstInvalid) firstInvalid = field;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            console.log('Form valid:', isValid);

            if (!isValid) {
                e.preventDefault();
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    if (firstInvalid.focus) firstInvalid.focus();
                }
            } else {
                console.log('Submitting form...');
            }
        });

        // Remove invalid state on input
        form.querySelectorAll('input, textarea, select').forEach(field => {
            field.addEventListener('input', () => field.classList.remove('is-invalid'));
        });
    });

    function addCustomTime() {
        addCustomTimeInput('');
    }

    function addCustomTimeInput(value) {
        const container = document.getElementById('custom-times-container');
        const div = document.createElement('div');
        div.className = 'input-group';
        div.innerHTML = `
        <input type="time" class="form-control" name="custom_time[]" value="${value}">
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
        container.appendChild(div);
    }
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Add Medication - MedGuardian{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <h2 class="fw-bold text-primary mb-2">Add New Medication</h2>
                <p class="text-muted">Set up your medication schedule in a few simple steps</p>
            </div>

            <form method="POST" action="{{ url_for('medication.add_medication') }}" class="needs-validation" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                <!-- Section 1: Basic Info -->
                <div class="card shadow-sm mb-4 border-0 rounded-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4 text-primary fw-bold">
                            <i class="fas fa-pills me-2"></i>Basic Information
                        </h5>

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="name" class="form-label">Medication Name</label>
                                <input type="text" class="form-control form-control-lg bg-light border-0" id="name"
                                    name="name" required placeholder="e.g. Metformin">
                                <div class="invalid-feedback">Please enter the medication name</div>
                            </div>
                            <div class="col-md-4">
                                <label for="dosage" class="form-label">Dosage</label>
                                <input type="text" class="form-control form-control-lg bg-light border-0" id="dosage"
                                    name="dosage" required placeholder="e.g. 500mg">
                                <div class="invalid-feedback">Please enter dosage</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 1.5: AI Training (Visual Recognition) -->
                <div class="card shadow-sm mb-4 border-0 rounded-4 border-info">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-3 text-info fw-bold">
                            <i class="fas fa-robot me-2"></i>AI Visual Recognition
                            <span class="badge bg-info bg-opacity-25 text-info ms-2">Optional</span>
                        </h5>
                        <p class="text-muted small mb-3">
                            Train AI to recognize this medication for automatic verification. Capture the bottle/strip
                            from multiple angles.
                        </p>

                        <!-- Hidden fields for training data -->
                        <input type="hidden" name="background_image" id="backgroundImageField" value="">
                        <input type="hidden" name="reference_images" id="referenceImagesField" value="">
                        <input type="hidden" name="ai_trained" id="aiTrainedField" value="false">

                        <!-- Training status display -->
                        <div id="trainingPreviewArea" class="mb-3" style="display: none;">
                            <div
                                class="d-flex align-items-center justify-content-between bg-success bg-opacity-10 p-3 rounded-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-check-circle text-success me-2 fa-lg"></i>
                                    <div>
                                        <strong class="text-success">AI Trained</strong>
                                        <div id="trainingPreviewCount" class="small text-muted">6 angles captured</div>
                                    </div>
                                </div>
                                <div id="trainingThumbnails" class="d-flex gap-1">
                                    <!-- Thumbnails will be inserted here -->
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearTraining()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Train AI button -->
                        <div id="trainButtonArea">
                            <button type="button" class="btn btn-outline-info btn-lg w-100"
                                onclick="openTrainingCapture()">
                                <i class="fas fa-camera me-2"></i>Train AI Recognition
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Schedule -->
                <div class="card shadow-sm mb-4 border-0 rounded-4">
                    <div class="card-body p-4">
                        <h5 class="card-title mb-4 text-primary fw-bold">
                            <i class="fas fa-clock me-2"></i>Schedule
                        </h5>

                        <!-- Frequency Selector -->
                        <div class="mb-4">
                            <label class="form-label mb-3">How often do you take this?</label>
                            <input type="hidden" id="frequency" name="frequency" required>

                            <div class="row g-2" id="frequency-options">
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="Once daily" data-times='["08:00"]' data-periods='["morning"]'>
                                        <i class="fas fa-sun d-block mb-2 text-warning fa-2x"></i>
                                        Once Daily
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="Twice daily" data-times='["08:00", "20:00"]'
                                        data-periods='["morning", "evening"]'>
                                        <i class="fas fa-sync-alt d-block mb-2 text-info fa-2x"></i>
                                        Twice Daily
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="Three times daily" data-times='["08:00", "12:00", "18:00"]'
                                        data-periods='["morning", "afternoon", "evening"]'>
                                        <i class="fas fa-clock d-block mb-2 text-primary fa-2x"></i>
                                        3x Daily
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="Every 8 hours" data-times='["08:00", "16:00", "00:00"]'
                                        data-periods='["morning", "evening", "night"]'>
                                        <i class="fas fa-hourglass-half d-block mb-2 text-secondary fa-2x"></i>
                                        Every 8h
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency"
                                        data-frequency="As needed" data-times='[]' data-periods='[]'>
                                        <i class="fas fa-hand-paper d-block mb-2 text-success fa-2x"></i>
                                        As Needed
                                    </button>
                                </div>
                                <div class="col-6 col-md-4">
                                    <button type="button"
                                        class="btn btn-outline-light text-dark w-100 p-3 border preset-frequency-custom">
                                        <i class="fas fa-cog d-block mb-2 text-dark fa-2x"></i>
                                        Custom
                                    </button>
                                </div>
                            </div>
                            <div class="invalid-feedback d-block" id="frequency-error" style="display:none !important;">
                                Please select a frequency</div>
                        </div>

                        <!-- Selected Frequency Display -->
                        <div id="selected-frequency"
                            class="alert alert-primary bg-primary bg-opacity-10 border-0 d-none mb-4">
                            <i class="fas fa-check-circle me-2"></i>
                            Selected: <strong id="frequency-display"></strong>
                        </div>

                        <!-- Time Periods -->
                        <div class="mb-4">
                            <label class="form-label mb-3">Time of Day</label>
                            <div class="row g-2">
                                <div class="col-3">
                                    <input type="checkbox" class="btn-check" name="morning" id="morning"
                                        autocomplete="off">
                                    <label class="btn btn-outline-warning w-100 p-2" for="morning">
                                        <i class="fas fa-sun d-block mb-1"></i>Morn
                                    </label>
                                </div>
                                <div class="col-3">
                                    <input type="checkbox" class="btn-check" name="afternoon" id="afternoon"
                                        autocomplete="off">
                                    <label class="btn btn-outline-info w-100 p-2" for="afternoon">
                                        <i class="fas fa-cloud-sun d-block mb-1"></i>Aftn
                                    </label>
                                </div>
                                <div class="col-3">
                                    <input type="checkbox" class="btn-check" name="evening" id="evening"
                                        autocomplete="off">
                                    <label class="btn btn-outline-primary w-100 p-2" for="evening">
                                        <i class="fas fa-cloud d-block mb-1"></i>Eve
                                    </label>
                                </div>
                                <div class="col-3">
                                    <input type="checkbox" class="btn-check" name="night" id="night" autocomplete="off">
                                    <label class="btn btn-outline-dark w-100 p-2" for="night">
                                        <i class="fas fa-moon d-block mb-1"></i>Night
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Custom Times -->
                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                <span>Specific Times</span>
                                <button type="button" class="btn btn-sm btn-light text-primary"
                                    onclick="addCustomTime()">
                                    <i class="fas fa-plus me-1"></i>Add Time
                                </button>
                            </label>
                            <div id="custom-times-container" class="vstack gap-2">
                                <!-- Times will be added here -->
                            </div>
                            <div class="form-text text-muted small" id="no-custom-times-msg">No specific times added
                                yet.</div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Details (Collapsible) -->
                <div class="card shadow-sm mb-5 border-0 rounded-4">
                    <div class="card-header bg-white border-0 py-3" role="button" data-bs-toggle="collapse"
                        data-bs-target="#detailsCollapse">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0 text-primary fw-bold">
                                <i class="fas fa-sliders-h me-2"></i>Additional Details
                            </h5>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                    </div>
                    <div class="collapse" id="detailsCollapse">
                        <div class="card-body p-4 pt-0">
                            <!-- Instructions -->
                            <div class="mb-4">
                                <label for="instructions" class="form-label">Special Instructions</label>
                                <textarea class="form-control bg-light border-0" id="instructions" name="instructions"
                                    rows="2" placeholder="e.g. Take with food"></textarea>
                            </div>

                            <!-- Dates -->
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label for="start_date" class="form-label">Start Date</label>
                                    <input type="date" class="form-control bg-light border-0" id="start_date"
                                        name="start_date" required value="{{ today }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="end_date" class="form-label">End Date (Optional)</label>
                                    <input type="date" class="form-control bg-light border-0" id="end_date"
                                        name="end_date">
                                </div>
                            </div>

                            <!-- Priority -->
                            <div class="mb-3">
                                <label class="form-label">Priority Level</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" name="priority" id="p_low" value="low"
                                        checked>
                                    <label class="btn btn-outline-secondary" for="p_low">Low</label>

                                    <input type="radio" class="btn-check" name="priority" id="p_med" value="medium">
                                    <label class="btn btn-outline-primary" for="p_med">Medium</label>

                                    <input type="radio" class="btn-check" name="priority" id="p_high" value="high">
                                    <label class="btn btn-outline-warning" for="p_high">High</label>

                                    <input type="radio" class="btn-check" name="priority" id="p_crit" value="critical">
                                    <label class="btn btn-outline-danger" for="p_crit">Critical</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit Actions -->
                <div class="d-grid gap-3 mb-5">
                    <button type="submit" class="btn btn-primary btn-lg rounded-pill py-3 fw-bold shadow-sm">
                        <i class="fas fa-check-circle me-2"></i>Save Medication
                    </button>
                    <a href="{{ url_for('medication.list_medications') }}"
                        class="btn btn-link text-muted text-decoration-none">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .preset-frequency.active {
        background-color: var(--bs-primary) !important;
        color: white !important;
        border-color: var(--bs-primary) !important;
    }

    .preset-frequency.active i {
        color: white !important;
    }

    .preset-frequency:hover {
        background-color: #f8f9fa;
        border-color: var(--bs-primary);
    }

    .form-control:focus,
    .form-select:focus {
        background-color: white !important;
        box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
    }

    .btn-check:checked+.btn-outline-warning {
        background-color: #ffc107;
        color: black;
    }

    .btn-check:checked+.btn-outline-info {
        background-color: #0dcaf0;
        color: white;
    }

    .btn-check:checked+.btn-outline-primary {
        background-color: #0d6efd;
        color: white;
    }

    .btn-check:checked+.btn-outline-dark {
        background-color: #212529;
        color: white;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Form validation
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()

    // Custom time management
    function addCustomTime() {
        const container = document.getElementById('custom-times-container');
        const msg = document.getElementById('no-custom-times-msg');
        if (msg) msg.style.display = 'none';

        const newTimeInput = document.createElement('div');
        newTimeInput.className = 'input-group mb-2';
        newTimeInput.innerHTML = `
        <input type="time" class="form-control bg-light border-0" name="custom_time[]">
        <button type="button" class="btn btn-outline-danger border-0" onclick="removeCustomTime(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
        container.appendChild(newTimeInput);
    }

    function removeCustomTime(button) {
        button.parentElement.remove();
        const container = document.getElementById('custom-times-container');
        if (container.children.length === 0) {
            document.getElementById('no-custom-times-msg').style.display = 'block';
        }
    }

    // Quick preset functionality
    document.addEventListener('DOMContentLoaded', function () {
        const frequencyButtons = document.querySelectorAll('.preset-frequency');
        const customBtn = document.querySelector('.preset-frequency-custom');

        // Helper to clear active states
        function clearActiveStates() {
            frequencyButtons.forEach(btn => btn.classList.remove('active'));
            if (customBtn) customBtn.classList.remove('active');
        }

        frequencyButtons.forEach(button => {
            button.addEventListener('click', function () {
                console.log("Preset clicked:", this.getAttribute('data-frequency'));
                clearActiveStates();
                this.classList.add('active');

                const frequency = this.getAttribute('data-frequency');
                let times = [];
                let periods = [];

                try {
                    const rawTimes = this.getAttribute('data-times');
                    const rawPeriods = this.getAttribute('data-periods');

                    if (rawTimes) times = JSON.parse(rawTimes);
                    if (rawPeriods) periods = JSON.parse(rawPeriods);
                } catch (e) {
                    console.error("Error parsing preset data:", e);
                }

                // Set frequency
                document.getElementById('frequency').value = frequency;
                document.getElementById('frequency-display').textContent = frequency;
                document.getElementById('selected-frequency').classList.remove('d-none');

                // Clear existing selections
                document.querySelectorAll('input[name="morning"], input[name="afternoon"], input[name="evening"], input[name="night"]').forEach(cb => cb.checked = false);
                const container = document.getElementById('custom-times-container');
                container.innerHTML = '';
                document.getElementById('no-custom-times-msg').style.display = 'block';

                // Set time periods
                periods.forEach(period => {
                    const checkbox = document.querySelector(`input[name="${period}"]`);
                    if (checkbox) checkbox.checked = true;
                });

                // Set custom times
                if (times.length > 0) {
                    document.getElementById('no-custom-times-msg').style.display = 'none';

                    times.forEach(time => {
                        const timeInput = document.createElement('div');
                        timeInput.className = 'input-group mb-2';
                        timeInput.innerHTML = `
                        <input type="time" class="form-control bg-light border-0" name="custom_time[]" value="${time}" readonly>
                        <button type="button" class="btn btn-outline-danger border-0" onclick="removeCustomTime(this)">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                        container.appendChild(timeInput);
                    });

                    // Visual feedback
                    container.style.transition = 'background-color 0.3s';
                    container.style.backgroundColor = '#fff3cd';
                    setTimeout(() => {
                        container.style.backgroundColor = 'transparent';
                    }, 500);
                }
            });
        });

        // Custom button
        if (customBtn) {
            customBtn.addEventListener('click', function () {
                clearActiveStates();
                this.classList.add('active');

                document.getElementById('frequency').value = 'Custom';
                document.getElementById('frequency-display').textContent = 'Custom Schedule';
                document.getElementById('selected-frequency').classList.remove('d-none');

                // Clear everything
                document.querySelectorAll('input[name="morning"], input[name="afternoon"], input[name="evening"], input[name="night"]').forEach(cb => cb.checked = false);
                document.getElementById('custom-times-container').innerHTML = '';

                // Add one empty time slot
                addCustomTime();
            });
        }
    });

    // ==============================================
    // AI TRAINING INTEGRATION
    // ==============================================

    // Open training capture modal
    function openTrainingCapture() {
        if (typeof window.trainingCapture !== 'undefined') {
            window.trainingCapture.openModal(onTrainingComplete, function () {
                console.log('Training cancelled');
            });
        } else {
            alert('Training system not loaded. Please refresh the page.');
        }
    }

    // Training complete callback
    function onTrainingComplete(trainingData) {
        // Handle new 2-phase format: {background, medications}
        const background = trainingData.background || null;
        const medications = trainingData.medications || [];

        console.log('Training complete:',
            background ? '1 background' : 'no background',
            medications.length, 'medication frames');

        // Store in hidden fields
        if (background) {
            document.getElementById('backgroundImageField').value = background;
        }
        document.getElementById('referenceImagesField').value = JSON.stringify(medications);
        document.getElementById('aiTrainedField').value = 'true';

        // Update UI
        document.getElementById('trainButtonArea').style.display = 'none';
        document.getElementById('trainingPreviewArea').style.display = 'block';

        const bgText = background ? '+ background' : '';
        document.getElementById('trainingPreviewCount').textContent =
            medications.length + ' medication angles ' + bgText;

        // Add thumbnails
        const thumbContainer = document.getElementById('trainingThumbnails');
        thumbContainer.innerHTML = '';

        // Add background thumbnail with different styling
        if (background) {
            const bgImg = document.createElement('img');
            bgImg.src = background;
            bgImg.title = 'Background (for subtraction)';
            bgImg.style.cssText = 'width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 2px solid #ff9800;';
            thumbContainer.appendChild(bgImg);
        }

        // Add medication thumbnails
        medications.slice(0, 3).forEach(frame => {
            const img = document.createElement('img');
            img.src = frame;
            img.style.cssText = 'width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 2px solid #00c853;';
            thumbContainer.appendChild(img);
        });

        if (medications.length > 3) {
            const more = document.createElement('span');
            more.className = 'badge bg-secondary';
            more.textContent = '+' + (medications.length - 3);
            thumbContainer.appendChild(more);
        }
    }

    // Clear training data
    function clearTraining() {
        document.getElementById('referenceImagesField').value = '';
        document.getElementById('aiTrainedField').value = 'false';
        document.getElementById('trainButtonArea').style.display = 'block';
        document.getElementById('trainingPreviewArea').style.display = 'none';
        document.getElementById('trainingThumbnails').innerHTML = '';
    }
</script>

<!-- Include Training Capture Script -->
<script src="{{ url_for('static', filename='js/training_capture.js') }}"></script>
{% endblock %}
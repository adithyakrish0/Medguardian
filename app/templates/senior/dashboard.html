{% extends "base.html" %}

{% block title %}Dashboard - MedGuardian{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Senior-Friendly Simplified Dashboard */
    .senior-dashboard {
        font-size: 1.2rem;
        max-width: 800px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .welcome-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .welcome-header h1 {
        font-size: 1.8rem;
        font-weight: 600;
        color: #333;
    }

    /* Main Alert Card */
    .alert-card {
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: center;
    }

    .alert-calm {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        border: 3px solid #28a745;
    }

    .alert-due {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        border: 3px solid #ffc107;
        animation: pulse-attention 2s infinite;
    }

    .alert-overdue {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border: 3px solid #dc3545;
        animation: pulse-urgent 1s infinite;
    }

    @keyframes pulse-attention {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.01);
        }
    }

    @keyframes pulse-urgent {

        0%,
        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4);
        }

        50% {
            transform: scale(1.02);
            box-shadow: 0 0 20px 5px rgba(220, 53, 69, 0.3);
        }
    }

    .alert-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .alert-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .alert-subtitle {
        font-size: 1.2rem;
        color: #555;
    }

    /* Medication Card */
    .med-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin: 1.5rem 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-left: 6px solid #667eea;
    }

    .med-name {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
    }

    .med-dosage {
        font-size: 1.3rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .med-instructions {
        font-size: 1.1rem;
        color: #888;
        font-style: italic;
    }

    /* Action Buttons */
    .action-btn-primary {
        display: block;
        width: 100%;
        padding: 1.5rem 2rem;
        font-size: 1.5rem;
        font-weight: 700;
        border: none;
        border-radius: 16px;
        cursor: pointer;
        margin-bottom: 1rem;
        text-decoration: none;
        text-align: center;
    }

    .btn-verify {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }

    .btn-verify:hover {
        background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
        color: white;
        transform: translateY(-2px);
    }

    .action-btn-secondary {
        display: inline-block;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        border: 2px solid #6c757d;
        border-radius: 12px;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        background: white;
        color: #6c757d;
        margin: 0.25rem;
    }

    .action-btn-secondary:hover {
        background: #f8f9fa;
        color: #495057;
    }

    /* Countdown */
    .countdown-section {
        text-align: center;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 16px;
        margin-bottom: 2rem;
    }

    .countdown-label {
        font-size: 1rem;
        color: #666;
        margin-bottom: 0.5rem;
    }

    .countdown-time {
        font-size: 2.5rem;
        font-weight: 700;
        color: #333;
    }

    .countdown-med {
        font-size: 1.2rem;
        color: #667eea;
        margin-top: 0.5rem;
    }

    /* Today's Schedule */
    .schedule-section {
        margin-top: 2rem;
    }

    .schedule-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
    }

    .schedule-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 12px;
        margin-bottom: 0.75rem;
        background: white;
        border: 2px solid #e9ecef;
    }

    .schedule-item.taken {
        background: #d4edda;
        border-color: #28a745;
    }

    .schedule-item.missed {
        background: #f8d7da;
        border-color: #dc3545;
    }

    .schedule-item.due {
        background: #fff3cd;
        border-color: #ffc107;
    }

    .schedule-item.upcoming {
        background: #e9ecef;
        border-color: #6c757d;
    }

    .schedule-status-icon {
        font-size: 1.5rem;
        margin-right: 1rem;
        width: 40px;
        text-align: center;
    }

    .schedule-time {
        font-size: 1.2rem;
        font-weight: 600;
        min-width: 100px;
    }

    .schedule-med-name {
        font-size: 1.1rem;
        color: #333;
        flex-grow: 1;
    }

    .schedule-status-text {
        font-size: 0.9rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
    }

    .status-taken {
        background: #28a745;
        color: white;
    }

    .status-missed {
        background: #dc3545;
        color: white;
    }

    .status-due {
        background: #ffc107;
        color: #333;
    }

    .status-upcoming {
        background: #6c757d;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="senior-dashboard">
    <!-- Welcome Header -->
    <div class="welcome-header">
        <h1>üëã Hello, {{ current_user.username }}!</h1>
    </div>

    <!-- Main Alert Card - Changes based on state -->
    {% if dashboard_state == 'calm' %}
    <!-- CALM STATE: No medication due -->
    <div class="alert-card alert-calm">
        <div class="alert-icon">‚úÖ</div>
        <div class="alert-title">You're All Caught Up!</div>
        <div class="alert-subtitle">No medication due right now</div>
    </div>

    {% if next_medication %}
    <div class="countdown-section">
        <div class="countdown-label">Next medication in:</div>
        <div class="countdown-time">{{ time_until_next or 'Soon' }}</div>
        <div class="countdown-med">
            <i class="fas fa-pills"></i> {{ next_medication.name }} ({{ next_medication.dosage }})
            at {{ next_medication.time_display }}
        </div>
    </div>
    {% endif %}

    {% elif dashboard_state == 'due' %}
    <!-- DUE STATE: Medication due now -->
    <div class="alert-card alert-due">
        <div class="alert-icon">üîî</div>
        <div class="alert-title">Time to Take Your Medication!</div>
        <div class="alert-subtitle">Due at {{ current_medication.time_display }}</div>
    </div>

    <div class="med-card">
        <div class="med-name">üíä {{ current_medication.name }}</div>
        <div class="med-dosage">{{ current_medication.dosage }}</div>
        {% if current_medication.instructions %}
        <div class="med-instructions">üìã {{ current_medication.instructions }}</div>
        {% endif %}
    </div>

    <a href="{{ url_for('medication.medication_reminder_page', medication_id=current_medication.id) }}"
        class="action-btn-primary btn-verify">
        ‚úÖ VERIFY & TAKE NOW
    </a>

    <div class="text-center">
        <a href="{{ url_for('snooze.snooze_medication', medication_id=current_medication.id) }}?duration=10"
            class="action-btn-secondary">
            ‚è∞ Snooze 10 min
        </a>
        <button type="button" class="action-btn-secondary" onclick="skipDose({{ current_medication.id }})">
            ‚è≠Ô∏è Skip Dose
        </button>
    </div>

    <script>
        function skipDose(medId) {
            if (!confirm('Are you sure you want to skip this dose?')) return;

            fetch('/medication/skip-dose/' + medId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({})
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Dose skipped successfully!');
                        window.location.reload();
                    } else {
                        alert('Error: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('Error skipping dose: ' + err);
                });
        }
    </script>


    {% elif dashboard_state == 'overdue' %}
    <!-- OVERDUE STATE: Medication past due -->
    <div class="alert-card alert-overdue">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-title">Medication Overdue!</div>
        <div class="alert-subtitle">Was due at {{ current_medication.time_display }}</div>
    </div>

    <div class="med-card">
        <div class="med-name">üíä {{ current_medication.name }}</div>
        <div class="med-dosage">{{ current_medication.dosage }}</div>
        {% if current_medication.instructions %}
        <div class="med-instructions">üìã {{ current_medication.instructions }}</div>
        {% endif %}
    </div>

    <a href="{{ url_for('medication.medication_reminder_page', medication_id=current_medication.id) }}"
        class="action-btn-primary btn-verify">
        ‚úÖ TAKE NOW
    </a>

    <div class="text-center">
        <button type="button" class="action-btn-secondary" onclick="skipDose({{ current_medication.id }})">
            ‚è≠Ô∏è Skip This Dose
        </button>
    </div>
    {% endif %}

    <!-- Today's Schedule -->
    {% if today_schedule %}
    <div class="schedule-section">
        <div class="schedule-title">
            <i class="fas fa-calendar-day me-2"></i> Today's Schedule
        </div>

        {% for dose in today_schedule %}
        <div class="schedule-item {{ dose.status }}">
            <div class="schedule-status-icon">
                {% if dose.status == 'taken' %}‚úÖ
                {% elif dose.status == 'missed' %}‚ùå
                {% elif dose.status == 'due' %}üîî
                {% else %}‚è∞
                {% endif %}
            </div>
            <div class="schedule-time">{{ dose.time_display }}</div>
            <div class="schedule-med-name">{{ dose.name }} ({{ dose.dosage }})</div>
            <span class="schedule-status-text status-{{ dose.status }}">
                {% if dose.status == 'taken' %}Done
                {% elif dose.status == 'missed' %}Missed
                {% elif dose.status == 'due' %}Take Now
                {% else %}Upcoming
                {% endif %}
            </span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Hidden compatibility data for existing JS -->
    <script>
        window.upcomingMedications = {{ upcoming_medications | tojson | safe }};
        window.nextMedicationId = {{ current_medication.id if current_medication else 'null' }};
    </script>
</div>
{% endblock %}
{% extends "base.html" %}

{% block title %}Dashboard - MedGuardian{% endblock %}

{% block head %}
{{ super() }}
<style>
    /* Compact Senior-Friendly Dashboard - Minimal Scrolling */
    .senior-dashboard {
        font-size: 1.1rem;
        max-width: 700px;
        margin: 0 auto;
        padding: 1rem;
    }

    /* Compact Welcome Header */
    .welcome-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 1rem 1.25rem;
        color: white;
        margin-bottom: 1rem;
    }

    .welcome-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .greeting-icon {
        font-size: 2rem;
    }

    .greeting-text h1 {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0;
        color: white;
    }

    .greeting-text .date {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    /* Compact Progress Summary - Inline */
    .progress-summary {
        display: flex;
        gap: 0.5rem;
    }

    .progress-badge {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.35rem 0.6rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        background: rgba(255, 255, 255, 0.2);
    }

    .progress-badge.taken {
        background: rgba(40, 167, 69, 0.3);
    }

    .progress-badge.remaining {
        background: rgba(255, 193, 7, 0.3);
    }

    .progress-badge.missed {
        background: rgba(220, 53, 69, 0.3);
    }

    /* Compact Alert Card */
    .alert-card {
        border-radius: 16px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .alert-calm {
        background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        color: white;
    }

    .alert-due {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        animation: pulse 2s infinite;
    }

    .alert-overdue {
        background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        color: white;
        animation: pulse 1s infinite;
    }

    @keyframes pulse {

        0%,
        100% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.01);
        }
    }

    .alert-content {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }

    .alert-icon {
        font-size: 2.5rem;
    }

    .alert-text .alert-title {
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0;
    }

    .alert-text .alert-subtitle {
        font-size: 1rem;
        opacity: 0.95;
    }

    /* Next Medication (Compact) */
    .next-med-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 2px solid #e9ecef;
    }

    .next-med-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .next-med-info .med-icon {
        font-size: 1.8rem;
    }

    .next-med-info .med-details .med-name {
        font-size: 1.1rem;
        font-weight: 600;
    }

    .next-med-info .med-details .med-time {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .countdown-badge {
        font-size: 1.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* Current Medication Card (When Due) */
    .current-med-card {
        background: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        border-left: 5px solid #667eea;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .current-med-card .med-icon {
        font-size: 2rem;
    }

    .current-med-card .med-details {
        flex: 1;
    }

    .current-med-card .med-name {
        font-size: 1.2rem;
        font-weight: 700;
    }

    .current-med-card .med-dosage {
        font-size: 1rem;
        color: #667eea;
        font-weight: 600;
    }

    .current-med-card .med-instructions {
        font-size: 0.9rem;
        color: #6c757d;
    }

    /* Action Buttons */
    .action-btn-primary {
        display: block;
        width: 100%;
        padding: 1rem;
        font-size: 1.2rem;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        margin-bottom: 0.75rem;
        text-decoration: none;
        text-align: center;
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
    }

    .action-btn-primary:hover {
        transform: translateY(-2px);
        color: white;
    }

    .secondary-actions {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .action-btn-secondary {
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        font-weight: 600;
        border: 2px solid #6c757d;
        border-radius: 10px;
        cursor: pointer;
        text-decoration: none;
        background: white;
        color: #6c757d;
    }

    .action-btn-secondary:hover {
        background: #6c757d;
        color: white;
    }

    /* Compact Schedule Section */
    .schedule-section {
        margin-top: 0.75rem;
    }

    .schedule-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    .schedule-title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
    }

    .view-all-link {
        font-size: 0.85rem;
        color: #667eea;
        text-decoration: none;
    }

    .schedule-item {
        display: flex;
        align-items: center;
        padding: 0.6rem 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        background: white;
        border: 1px solid #e9ecef;
    }

    .schedule-item.taken {
        background: #d4edda;
        border-color: #28a745;
    }

    .schedule-item.missed {
        background: #f8d7da;
        border-color: #dc3545;
    }

    .schedule-item.due {
        background: #fff3cd;
        border-color: #ffc107;
    }

    .schedule-item.upcoming {
        background: #f8f9fa;
    }

    .schedule-icon {
        font-size: 1.2rem;
        width: 30px;
        text-align: center;
    }

    .schedule-time {
        font-size: 0.95rem;
        font-weight: 600;
        min-width: 75px;
    }

    .schedule-med {
        flex: 1;
        font-size: 0.95rem;
    }

    .schedule-status {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        text-transform: uppercase;
    }

    .status-taken {
        background: #28a745;
        color: white;
    }

    .status-missed {
        background: #dc3545;
        color: white;
    }

    .status-due {
        background: #ffc107;
        color: #333;
    }

    .status-upcoming {
        background: #6c757d;
        color: white;
    }

    /* Compact Quick Actions */
    .quick-actions {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e9ecef;
        margin-top: 0.75rem;
    }

    .quick-action-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        text-decoration: none;
        color: #495057;
        font-size: 0.8rem;
        min-width: 70px;
    }

    .quick-action-btn:hover {
        border-color: #667eea;
        color: #667eea;
    }

    .quick-action-btn .action-icon {
        font-size: 1.3rem;
    }

    .quick-action-btn .action-label {
        font-size: 0.75rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="senior-dashboard">
    <!-- Compact Welcome Header with Progress -->
    <div class="welcome-header">
        <div class="welcome-left">
            <span class="greeting-icon">
                {% set hour = now_hour|default(12) %}
                {% if hour < 12 %}‚òÄÔ∏è{% elif hour < 17 %}üå§Ô∏è{% elif hour < 20 %}üåÖ{% else %}üåô{% endif %} </span>
                    <div class="greeting-text">
                        <h1>{% if hour < 12 %}Good Morning{% elif hour < 17 %}Good Afternoon{% elif hour < 20 %}Good
                                Evening{% else %}Good Night{% endif %}, {{ current_user.username }}!</h1>
                                <div class="date">{{ today_date }}</div>
                    </div>
        </div>
        {% if today_schedule %}
        {% set taken_count = today_schedule|selectattr('status', 'equalto', 'taken')|list|length %}
        {% set remaining_count = today_schedule|selectattr('status', 'in', ['upcoming', 'due'])|list|length %}
        <div class="progress-summary">
            <span class="progress-badge taken">‚úÖ {{ taken_count }}</span>
            <span class="progress-badge remaining">‚è≥ {{ remaining_count }}</span>
        </div>
        {% endif %}
    </div>

    <!-- Main Alert Card -->
    {% if dashboard_state == 'calm' %}
    <div class="alert-card alert-calm">
        <div class="alert-content">
            <span class="alert-icon">üéâ</span>
            <div class="alert-text">
                <div class="alert-title">All Caught Up!</div>
                <div class="alert-subtitle">No medication due right now</div>
            </div>
        </div>
    </div>

    {% if next_medication %}
    <div class="next-med-card">
        <div class="next-med-info">
            <span class="med-icon">üíä</span>
            <div class="med-details">
                <div class="med-name">{{ next_medication.name }}</div>
                <div class="med-time">at {{ next_medication.time_display }}</div>
            </div>
        </div>
        <div class="countdown-badge">{{ time_until_next or 'Soon' }}</div>
    </div>
    {% endif %}

    {% elif dashboard_state == 'due' %}
    <div class="alert-card alert-due">
        <div class="alert-content">
            <span class="alert-icon">üîî</span>
            <div class="alert-text">
                <div class="alert-title">Time to Take Medication!</div>
                <div class="alert-subtitle">Due at {{ current_medication.time_display }}</div>
            </div>
        </div>
    </div>

    <div class="current-med-card">
        <span class="med-icon">üíä</span>
        <div class="med-details">
            <div class="med-name">{{ current_medication.name }}</div>
            <div class="med-dosage">{{ current_medication.dosage }}</div>
            {% if current_medication.instructions %}
            <div class="med-instructions">{{ current_medication.instructions }}</div>
            {% endif %}
        </div>
    </div>

    <a href="{{ url_for('medication.medication_reminder_page', medication_id=current_medication.id) }}"
        class="action-btn-primary">
        ‚úÖ VERIFY & TAKE NOW
    </a>

    <div class="secondary-actions">
        <button type="button" class="action-btn-secondary" onclick="snoozeDose({{ current_medication.id }})">‚è∞
            Snooze</button>
        <button type="button" class="action-btn-secondary" onclick="skipDose({{ current_medication.id }})">
            ‚è≠Ô∏è Skip
        </button>
    </div>

    {% elif dashboard_state == 'overdue' %}
    <div class="alert-card alert-overdue">
        <div class="alert-content">
            <span class="alert-icon">‚ö†Ô∏è</span>
            <div class="alert-text">
                <div class="alert-title">Medication Overdue!</div>
                <div class="alert-subtitle">Was due at {{ current_medication.time_display }}</div>
            </div>
        </div>
    </div>

    <div class="current-med-card">
        <span class="med-icon">üíä</span>
        <div class="med-details">
            <div class="med-name">{{ current_medication.name }}</div>
            <div class="med-dosage">{{ current_medication.dosage }}</div>
        </div>
    </div>

    <a href="{{ url_for('medication.medication_reminder_page', medication_id=current_medication.id) }}"
        class="action-btn-primary">
        ‚úÖ TAKE NOW
    </a>

    <div class="secondary-actions">
        <button type="button" class="action-btn-secondary" onclick="skipDose({{ current_medication.id }})">
            ‚è≠Ô∏è Skip
        </button>
    </div>
    {% endif %}

    <!-- Compact Schedule (Show only next 4) -->
    {% if today_schedule %}
    <div class="schedule-section">
        <div class="schedule-header">
            <span class="schedule-title">üìÖ Today's Schedule</span>
            <a href="{{ url_for('medication.list_medications') }}" class="view-all-link">View All ‚Üí</a>
        </div>

        {% for dose in today_schedule[:4] %}
        <div class="schedule-item {{ dose.status }}">
            <span class="schedule-icon">
                {% if dose.status == 'taken' %}‚úÖ{% elif dose.status == 'missed' %}‚ùå{% elif dose.status == 'due' %}üîî{%
                else %}‚è∞{% endif %}
            </span>
            <span class="schedule-time">{{ dose.time_display }}</span>
            <span class="schedule-med">{{ dose.name }}</span>
            <span class="schedule-status status-{{ dose.status }}">
                {% if dose.status == 'taken' %}Done{% elif dose.status == 'missed' %}Missed{% elif dose.status == 'due'
                %}Now{% else %}Later{% endif %}
            </span>
        </div>
        {% endfor %}

        {% if today_schedule|length > 4 %}
        <div style="text-align: center; padding: 0.5rem; color: #6c757d; font-size: 0.85rem;">
            +{{ today_schedule|length - 4 }} more scheduled
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Compact Quick Actions -->
    <div class="quick-actions">
        <a href="{{ url_for('medication.list_medications') }}" class="quick-action-btn">
            <span class="action-icon">üíä</span>
            <span class="action-label">Meds</span>
        </a>
        <a href="{{ url_for('emergency.sos') }}" class="quick-action-btn">
            <span class="action-icon">üÜò</span>
            <span class="action-label">SOS</span>
        </a>
        <a href="{{ url_for('print_schedule.schedule_page') }}" class="quick-action-btn">
            <span class="action-icon">üìã</span>
            <span class="action-label">Print</span>
        </a>
        <a href="{{ url_for('interaction.check_interactions') }}" class="quick-action-btn">
            <span class="action-icon">‚öïÔ∏è</span>
            <span class="action-label">Check</span>
        </a>
    </div>

    <script>
        window.upcomingMedications = {{ upcoming_medications | tojson | safe }};
        window.nextMedicationId = {{ current_medication.id if current_medication else 'null' }};

        function skipDose(medId) {
            if (!confirm('Skip this dose?')) return;
            fetch('/medication/skip-dose/' + medId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({})
            })
                .then(r => r.json())
                .then(d => { if (d.success) { alert('Skipped!'); location.reload(); } else { alert('Error: ' + d.error); } })
                .catch(e => alert('Error: ' + e));
        }

        function snoozeDose(medId) {
            if (!confirm('Snooze this medication for 10 minutes?')) return;
            fetch('/snooze/create-snooze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
                body: JSON.stringify({
                    medication_id: medId,
                    snooze_duration_minutes: 10,
                    original_medication_time: new Date().toISOString()
                })
            })
                .then(r => r.json())
                .then(d => { if (d.success) { alert('Snoozed for 10 minutes!'); location.reload(); } else { alert('Error: ' + d.message); } })
                .catch(e => alert('Error: ' + e));
        }
    </script>
</div>
{% endblock %}
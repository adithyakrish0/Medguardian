<!-- Floating Test Medication Button -->
<style>
    .floating-test-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        background: var(--primary-color);
        border: none;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        color: white;
        font-size: 24px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .floating-test-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 28px rgba(102, 126, 234, 0.6);
    }

    .floating-test-btn:active {
        transform: translateY(0);
    }

    .floating-test-btn .tooltip-text {
        visibility: hidden;
        position: absolute;
        right: 80px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        white-space: nowrap;
        font-size: 14px;
        font-weight: 600;
    }

    .floating-test-btn:hover .tooltip-text {
        visibility: visible;
    }

    #testMedicationModal .modal-content {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    }
</style>

<!-- Floating Button -->
<button class="floating-test-btn" onclick="openTestModal()">
    <i class="fas fa-vial"></i>
    <span class="tooltip-text">ðŸ§ª Quick Test (2min)</span>
</button>

<!-- Test Modal -->
<div class="modal fade" id="testMedicationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-vial me-2"></i>Quick Test Medication
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    This will create a test medication scheduled <strong>2 minutes from now</strong> to test the
                    reminder system.
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-pills me-2"></i>Medication Name</label>
                    <input type="text" class="form-control" id="testMedName" value="Test Aspirin"
                        placeholder="Enter medication name">
                </div>

                <div class="mb-3">
                    <label class="form-label"><i class="fas fa-prescription-bottle me-2"></i>Dosage</label>
                    <input type="text" class="form-control" id="testDosage" value="100mg" placeholder="e.g., 100mg">
                </div>

                <div class="alert alert-warning mb-0">
                    <small><i class="fas fa-clock me-1"></i>Scheduled Time: <strong id="testTime"></strong></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createTestMedication()">
                    <i class="fas fa-plus-circle me-2"></i>Create Test Medication
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function openTestModal() {
        // Calculate time 2 minutes from now
        const now = new Date();
        now.setMinutes(now.getMinutes() + 2);
        const timeStr = now.toTimeString().slice(0, 5);
        document.getElementById('testTime').textContent = timeStr;

        const modal = new bootstrap.Modal(document.getElementById('testMedicationModal'));
        modal.show();
    }

    async function createTestMedication() {
        const name = document.getElementById('testMedName').value || 'Test Medication';
        const dosage = document.getElementById('testDosage').value || '100mg';

        // Calculate time 2 minutes from now
        const now = new Date();
        now.setMinutes(now.getMinutes() + 2);
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const customTime = `${hour}:${minute}`;

        try {
            const response = await fetch('/api/v1/medications/quick-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    dosage: dosage,
                    custom_time: customTime
                })
            });

            const data = await response.json();

            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('testMedicationModal')).hide();

                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
                alertDiv.innerHTML = `
                <strong>âœ… Test Created!</strong><br>
                <small>Medication: ${name} ${dosage}</small><br>
                <small>Reminder at: ${customTime}</small><br>
                <small class="text-muted">Wait ~2 minutes for notification!</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
                document.body.appendChild(alertDiv);

                setTimeout(() => alertDiv.remove(), 8000);

                // Reload page to show new medication
                setTimeout(() => window.location.reload(), 2000);
            } else {
                alert('Error: ' + (data.error || 'Failed to create test medication'));
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error. Please try again.');
        }
    }
</script>
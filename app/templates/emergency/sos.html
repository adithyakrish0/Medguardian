{% extends "base.html" %}

{% block title %}Emergency SOS - MedGuardian{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <!-- SOS Card -->
            <div class="card shadow-lg border-danger">
                <div class="card-header bg-danger text-white text-center py-4">
                    <h2 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Emergency SOS</h2>
                </div>
                <div class="card-body text-center py-5">
                    <div id="sosNormal">
                        <p class="lead mb-4">Press the button below to alert your emergency contacts.</p>

                        <button id="sosButton" class="btn btn-danger btn-lg rounded-circle"
                            style="width: 150px; height: 150px; font-size: 2rem;" onclick="triggerSOS()">
                            <i class="fas fa-phone-alt fa-2x"></i>
                            <br><span style="font-size: 1rem;">SOS</span>
                        </button>

                        <p class="text-muted mt-4">
                            <i class="fas fa-info-circle me-1"></i>
                            This will send an emergency alert with your medical information.
                        </p>
                    </div>

                    <div id="sosActivating" style="display: none;">
                        <div class="spinner-border text-danger mb-3" style="width: 100px; height: 100px;" role="status">
                            <span class="visually-hidden">Activating...</span>
                        </div>
                        <h3 class="text-danger">Activating Emergency Alert...</h3>
                        <p class="text-muted">Sending notifications to emergency contacts</p>
                    </div>

                    <div id="sosActivated" style="display: none;">
                        <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
                        <h3 class="text-success">Emergency Alert Sent!</h3>
                        <p>Your emergency contacts have been notified.</p>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-phone me-2"></i>
                            If this is a medical emergency, also call <strong>108</strong> (Ambulance) or
                            <strong>112</strong> (Emergency)
                        </div>
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-primary mt-3">
                            <i class="fas fa-home me-1"></i>Return to Dashboard
                        </a>
                    </div>
                </div>
            </div>

            <!-- Medical Info Card -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-id-card-alt me-2"></i>Your Medical Information</h5>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ current_user.username }}</p>
                    <p><strong>Email:</strong> {{ current_user.email }}</p>

                    <h6 class="mt-3">Current Medications:</h6>
                    {% set medications = [] %}
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item text-muted">Loading medications...</li>
                    </ul>

                    <div class="mt-3">
                        <a href="{{ url_for('emergency.medical_info') }}" class="btn btn-outline-info btn-sm"
                            target="_blank">
                            <i class="fas fa-print me-1"></i>Print Medical Card
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function triggerSOS() {
        const button = document.getElementById('sosButton');

        // Confirm
        if (!confirm('Are you sure you want to trigger an emergency SOS? This will alert your emergency contacts.')) {
            return;
        }

        // Show activating state
        document.getElementById('sosNormal').style.display = 'none';
        document.getElementById('sosActivating').style.display = 'block';

        try {
            const response = await fetch('/emergency/api/trigger', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            const data = await response.json();

            // Show activated state
            document.getElementById('sosActivating').style.display = 'none';
            document.getElementById('sosActivated').style.display = 'block';

            if (!data.success) {
                alert('Warning: ' + (data.error || 'There was an issue sending the alert'));
            }

        } catch (error) {
            console.error('SOS error:', error);
            document.getElementById('sosActivating').style.display = 'none';
            document.getElementById('sosNormal').style.display = 'block';
            alert('Failed to send emergency alert. Please try again or call emergency services directly.');
        }
    }
</script>
{% endblock %}
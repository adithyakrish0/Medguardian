{% extends "base.html" %}

{% block title %}Medication Verification{% endblock %}

{% block head %}
{{ super() }}
<!-- Three.js for AR HUD -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
    .verification-page .page-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        margin-bottom: 1.5rem;
    }

    .verification-page .card {
        border-radius: 16px;
        border: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .verification-page .card-header {
        border-radius: 16px 16px 0 0 !important;
    }

    #camera-feed {
        background-color: #1a1a2e;
        min-height: 350px;
    }

    .camera-error-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 350px;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: white;
    }

    .camera-loading-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 350px;
        background: #1a1a2e;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid verification-page py-4">
    <!-- Page Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-1">
                    <i class="fas fa-camera me-2"></i>Medication Verification
                </h2>
                <p class="mb-0 opacity-90">Verify your medication with camera or upload an image</p>
            </div>
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-light">
                <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Camera Preview Section -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-crosshairs me-2"></i>AR Med-Scanner</h5>
                </div>
                <div class="card-body bg-dark p-0 position-relative" id="camera-container">
                    <!-- Loading State -->
                    <div id="camera-loading" class="camera-loading-state">
                        <div class="spinner-border text-light mb-3" style="width: 3rem; height: 3rem;"></div>
                        <p class="mb-1">Initializing camera...</p>
                        <small class="text-muted">This may take a few seconds</small>
                    </div>

                    <!-- Camera Feed (hidden initially) -->
                    <img id="camera-feed" src="" class="w-100 d-none" style="object-fit: contain;" alt="Camera feed">

                    <!-- Error State (hidden initially) -->
                    <div id="camera-error" class="camera-error-state d-none">
                        <i class="fas fa-video-slash fa-4x mb-3 text-danger"></i>
                        <h5 class="mb-2">Camera Not Available</h5>
                        <p class="text-muted mb-3" id="camera-error-message">Unable to access camera</p>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="retryCamera()">
                                <i class="fas fa-redo me-1"></i>Retry
                            </button>
                            <button class="btn btn-outline-light" onclick="showUploadSection()">
                                <i class="fas fa-upload me-1"></i>Upload Image Instead
                            </button>
                        </div>
                    </div>

                    <!-- Status Badge -->
                    <div id="detection-status" class="position-absolute top-0 end-0 m-3">
                        <span class="badge bg-secondary fs-6">Initializing...</span>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <span class="badge bg-info me-2">Bottles: <span id="bottle-count">0</span></span>
                            <span class="badge bg-success me-2">Barcodes: <span id="barcode-count">0</span></span>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="capture-btn" class="btn btn-primary btn-lg" onclick="captureAndVerify()"
                                disabled>
                                <i class="fas fa-crosshairs me-1"></i>Scan Medication
                            </button>
                            <button id="manual-btn" class="btn btn-success" onclick="showManualConfirm()">
                                <i class="fas fa-check me-1"></i>Mark Taken Manually
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Verification Controls -->
        <div class="col-lg-4 mb-4">
            <div class="card mb-4">
                <div class="card-header bg-success text-white py-3">
                    <h5 class="mb-0"><i class="fas fa-pills me-2"></i>Select Medication</h5>
                </div>
                <div class="card-body">
                    <select id="medication-select" class="form-select form-select-lg mb-3">
                        <option value="">Choose medication...</option>
                        {% for med in medications %}
                        <option value="{{ med.id }}">{{ med.name }} ({{ med.dosage }})</option>
                        {% endfor %}
                    </select>

                    <div class="alert alert-info mb-0">
                        <h6><i class="fas fa-lightbulb me-2"></i>Tips</h6>
                        <ul class="mb-0 ps-3 small">
                            <li>Hold medication bottle 6-12 inches from camera</li>
                            <li>Ensure good lighting</li>
                            <li>Keep barcode visible if possible</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Verification Results -->
            <div class="card">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Results</h5>
                </div>
                <div class="card-body">
                    <div id="verification-results">
                        <p class="text-muted text-center mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            Select a medication and capture to verify
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Section (Alternative Method) -->
    <div class="row" id="upload-section">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light py-3">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Alternative: Upload Image</h5>
                </div>
                <div class="card-body">
                    <form id="upload-form" class="row g-3 align-items-end">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <div class="col-md-4">
                            <label for="medication-upload-select" class="form-label">Medication</label>
                            <select id="medication-upload-select" class="form-select" required>
                                <option value="">Choose...</option>
                                {% for med in medications %}
                                <option value="{{ med.id }}">{{ med.name }} ({{ med.dosage }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-5">
                            <label for="image-file" class="form-label">Choose Image</label>
                            <input type="file" class="form-control" id="image-file" accept="image/*" required>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-upload me-1"></i>Upload & Verify
                            </button>
                        </div>
                    </form>
                    <div id="upload-results" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Confirmation Modal -->
<div class="modal fade" id="manualConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header bg-success text-white" style="border-radius: 16px 16px 0 0;">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Confirm Medication</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body py-4">
                <p>Are you confirming that you have taken this medication?</p>
                <select id="manual-medication-select" class="form-select form-select-lg">
                    <option value="">Choose medication...</option>
                    {% for med in medications %}
                    <option value="{{ med.id }}">{{ med.name }} ({{ med.dosage }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmManualTaken()">
                    <i class="fas fa-check me-1"></i>Yes, I've Taken It
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Camera state
    let cameraReady = false;
    let cameraTimeout = null;
    const CAMERA_TIMEOUT_MS = 8000; // 8 seconds timeout

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
        initCamera();

        // Sync medication selects
        document.getElementById('medication-select').addEventListener('change', function () {
            document.getElementById('medication-upload-select').value = this.value;
            document.getElementById('manual-medication-select').value = this.value;
        });
    });

    // Initialize camera with timeout
    function initCamera() {
        const loadingEl = document.getElementById('camera-loading');
        const feedEl = document.getElementById('camera-feed');
        const errorEl = document.getElementById('camera-error');
        const statusEl = document.getElementById('detection-status');
        const captureBtn = document.getElementById('capture-btn');

        // Show loading
        loadingEl.classList.remove('d-none');
        feedEl.classList.add('d-none');
        errorEl.classList.add('d-none');
        statusEl.innerHTML = '<span class="badge bg-warning fs-6">Loading...</span>';

        // Set timeout
        cameraTimeout = setTimeout(() => {
            if (!cameraReady) {
                showCameraError('Camera took too long to initialize. It may not be available.');
            }
        }, CAMERA_TIMEOUT_MS);

        // Try to load camera feed
        feedEl.onload = function () {
            clearTimeout(cameraTimeout);
            cameraReady = true;
            loadingEl.classList.add('d-none');
            feedEl.classList.remove('d-none');
            statusEl.innerHTML = '<span class="badge bg-success fs-6"><i class="fas fa-circle me-1"></i>Camera Active</span>';
            captureBtn.disabled = false;
            console.log('Camera initialized successfully');
        };

        feedEl.onerror = function () {
            clearTimeout(cameraTimeout);
            showCameraError('Failed to connect to camera feed. Please check camera permissions.');
        };

        // Start loading the feed
        feedEl.src = "{{ url_for('medication.video_feed') }}?" + Date.now();
    }

    // Show camera error
    function showCameraError(message) {
        const loadingEl = document.getElementById('camera-loading');
        const feedEl = document.getElementById('camera-feed');
        const errorEl = document.getElementById('camera-error');
        const statusEl = document.getElementById('detection-status');
        const errorMsgEl = document.getElementById('camera-error-message');

        loadingEl.classList.add('d-none');
        feedEl.classList.add('d-none');
        errorEl.classList.remove('d-none');
        errorMsgEl.textContent = message;
        statusEl.innerHTML = '<span class="badge bg-danger fs-6"><i class="fas fa-times me-1"></i>Error</span>';
        cameraReady = false;
        console.error('Camera error:', message);
    }

    // Retry camera
    function retryCamera() {
        cameraReady = false;
        initCamera();
    }

    // Show upload section (scroll to it)
    function showUploadSection() {
        document.getElementById('upload-section').scrollIntoView({ behavior: 'smooth' });
    }

    // Capture and verify
    async function captureAndVerify() {
        const medicationId = document.getElementById('medication-select').value;

        if (!medicationId) {
            showAlert('Please select a medication first', 'warning');
            return;
        }

        if (!cameraReady) {
            showAlert('Camera is not available. Please use image upload instead.', 'warning');
            return;
        }

        const captureBtn = document.getElementById('capture-btn');
        captureBtn.disabled = true;
        captureBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Verifying...';

        try {
            const response = await fetch(`/medication/verify-medication/${medicationId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ capture_mode: 'single' })
            });

            const result = await response.json();
            displayResults(result);
        } catch (error) {
            console.error('Verification error:', error);
            showAlert('Verification failed. Try uploading an image instead.', 'danger');
        } finally {
            captureBtn.disabled = false;
            captureBtn.innerHTML = '<i class="fas fa-camera me-1"></i>Capture & Verify';
        }
    }

    // Display results
    function displayResults(result) {
        const resultsDiv = document.getElementById('verification-results');
        const alertClass = result.success ? 'alert-success' : 'alert-warning';
        const icon = result.success ? 'check-circle text-success' : 'exclamation-triangle text-warning';

        resultsDiv.innerHTML = `
            <div class="alert ${alertClass}">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-${icon} fa-2x me-3"></i>
                    <div>
                        <h6 class="mb-0">${result.success ? 'Verified!' : 'Could Not Verify'}</h6>
                        <small>${result.message}</small>
                    </div>
                </div>
                <hr>
                <div class="row small">
                    <div class="col-6">Bottles Detected: <strong>${result.detected_bottles || 0}</strong></div>
                    <div class="col-6">Barcode Match: <strong>${result.barcode_verified ? 'Yes' : 'No'}</strong></div>
                </div>
                ${!result.success ? '<div class="mt-2"><button class="btn btn-sm btn-success" onclick="showManualConfirm()"><i class="fas fa-check me-1"></i>Mark Taken Anyway</button></div>' : ''}
            </div>
        `;

        document.getElementById('bottle-count').textContent = result.detected_bottles || 0;
        document.getElementById('barcode-count').textContent = result.barcodes ? result.barcodes.length : 0;
    }

    // Show manual confirmation modal
    function showManualConfirm() {
        const selectedMed = document.getElementById('medication-select').value;
        if (selectedMed) {
            document.getElementById('manual-medication-select').value = selectedMed;
        }
        new bootstrap.Modal(document.getElementById('manualConfirmModal')).show();
    }

    // Confirm manual taken
    async function confirmManualTaken() {
        const medicationId = document.getElementById('manual-medication-select').value;
        if (!medicationId) {
            alert('Please select a medication');
            return;
        }

        try {
            const response = await fetch(`/medication/mark-taken/${medicationId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('manualConfirmModal')).hide();
                showAlert('✅ Medication marked as taken!', 'success');
            } else {
                showAlert('Failed to mark medication. Please try again.', 'danger');
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'danger');
        }
    }

    // Upload form handler
    document.getElementById('upload-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const medicationId = document.getElementById('medication-upload-select').value;
        const imageFile = document.getElementById('image-file').files[0];

        if (!medicationId || !imageFile) {
            showAlert('Please select medication and image', 'warning', 'upload-results');
            return;
        }

        const formData = new FormData();
        formData.append('image', imageFile);

        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Verifying...';

        try {
            const response = await fetch(`/medication/verify-medication/${medicationId}`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            displayUploadResults(result);
        } catch (error) {
            showAlert('Upload failed: ' + error.message, 'danger', 'upload-results');
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload me-1"></i>Upload & Verify';
        }
    });

    // Display upload results  
    function displayUploadResults(result) {
        const resultsDiv = document.getElementById('upload-results');
        const alertClass = result.success ? 'alert-success' : 'alert-warning';

        resultsDiv.innerHTML = `
            <div class="alert ${alertClass}">
                <strong>${result.success ? '✅ Verified!' : '⚠️ Could Not Verify'}</strong>
                <p class="mb-1">${result.message}</p>
                <small>Bottles: ${result.detected_bottles || 0} | Barcode: ${result.barcode_verified ? 'Yes' : 'No'}</small>
            </div>
        `;
    }

    // Helper
    function showAlert(message, type, targetId = 'verification-results') {
        document.getElementById(targetId).innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    // =========================================================================
    // AR Med-Scanner HUD Integration
    // =========================================================================
    let arScanner = null;

    function initARScanner() {
        const container = document.getElementById('camera-container');
        if (container && typeof ARMedScanner !== 'undefined') {
            arScanner = new ARMedScanner(container);
            console.log('✅ AR Med-Scanner HUD active');
        }
    }

    // Override captureAndVerify to use AR scanner animations
    const originalCaptureAndVerify = captureAndVerify;
    captureAndVerify = async function () {
        const medicationId = document.getElementById('medication-select').value;

        if (!medicationId) {
            showAlert('Please select a medication first', 'warning');
            return;
        }

        if (!cameraReady) {
            showAlert('Camera is not available. Please use image upload instead.', 'warning');
            return;
        }

        const captureBtn = document.getElementById('capture-btn');
        captureBtn.disabled = true;
        captureBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Scanning...';

        // Trigger AR scanner animation
        if (arScanner) {
            arScanner.startScan();
            setTimeout(() => arScanner.processing(), 800);
        }

        try {
            const response = await fetch(`/medication/verify-medication/${medicationId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ capture_mode: 'single' })
            });

            const result = await response.json();

            // Trigger success/error animation
            if (arScanner) {
                if (result.success) {
                    arScanner.success();
                } else {
                    arScanner.error();
                }
            }

            displayResults(result);
        } catch (error) {
            console.error('Verification error:', error);
            if (arScanner) arScanner.error();
            showAlert('Verification failed. Try uploading an image instead.', 'danger');
        } finally {
            captureBtn.disabled = false;
            captureBtn.innerHTML = '<i class="fas fa-crosshairs me-1"></i>Scan Medication';
        }
    };

    // Initialize AR Scanner when camera is ready
    const originalInitCamera = initCamera;
    initCamera = function () {
        originalInitCamera();
        // Delay AR scanner init until camera container is properly sized
        setTimeout(initARScanner, 500);
    };
</script>

<!-- AR Scanner HUD Script -->
<script src="{{ url_for('static', filename='js/ar_scanner_hud.js') }}"></script>
{% endblock %}
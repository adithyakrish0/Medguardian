# Add this to the end of app/routes/medication.py

@medication.route('/history')
@login_required
def medication_history():
    """View medication history"""
    from app.models.medication import Medication
    from app.models.medication_log import MedicationLog
    
    medications = Medication.query.filter_by(user_id=current_user.id).all()
    logs = MedicationLog.query.filter_by(user_id=current_user.id).order_by(
        MedicationLog.taken_at.desc()
    ).limit(100).all()
    
    return render_template('medication/history.html',
                         medications=medications,
                         logs=logs)

@medication.route('/export-history/<format>')
@login_required
def export_history(format):
    """Export medication history"""
    from app.models.medication import Medication
    from app.models.medication_log import MedicationLog
    from app.utils.export import export_to_csv, export_to_pdf
    
    medications = Medication.query.filter_by(user_id=current_user.id).all()
    logs = MedicationLog.query.filter_by(user_id=current_user.id).order_by(
        MedicationLog.taken_at.desc()
    ).all()
    
    if format == 'csv':
        return export_to_csv(logs, medications)
    elif format == 'pdf':
        return export_to_pdf(logs, medications, current_user)
    else:
        flash('Invalid export format', 'error')
        return redirect(url_for('medication.medication_history'))

@medication.route('/log-details/<int:log_id>')
@login_required
def log_details(log_id):
    """Get details for a specific log"""
    from app.models.medication_log import MedicationLog
    
    log = MedicationLog.query.get_or_404(log_id)
    
    # Security check
    if log.user_id != current_user.id:
        return jsonify({'error': 'Unauthorized'}), 403
    
    return jsonify({
        'medication_name': log.medication.name,
        'dosage': log.medication.dosage,
        'scheduled_time': log.scheduled_time.strftime('%I:%M %p') if log.scheduled_time else 'N/A',
        'taken_at': log.taken_at.strftime('%B %d, %Y %I:%M %p'),
        'status': 'Taken correctly' if log.taken_correctly else 'Missed',
        'verified_by_camera': log.verified_by_camera,
        'notes': log.notes or 'No notes'
    })
